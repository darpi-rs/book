<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Extractors - Web Asynchronous Programming in Rust with darpi</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../01_getting_started/01_chapter.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01_getting_started/02_why_darpi.html"><strong aria-hidden="true">1.1.</strong> Why Darpi?</a></li><li class="chapter-item expanded "><a href="../01_getting_started/03_state_of_web_frameworks.html"><strong aria-hidden="true">1.2.</strong> The State of Web Frameworks</a></li></ol></li><li class="chapter-item expanded "><a href="../02_basics/01_chapter.html"><strong aria-hidden="true">2.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02_basics/02_app.html"><strong aria-hidden="true">2.1.</strong> App</a></li><li class="chapter-item expanded "><a href="../02_basics/03_handlers.html"><strong aria-hidden="true">2.2.</strong> Handlers</a></li><li class="chapter-item expanded "><a href="../02_basics/04_errors.html"><strong aria-hidden="true">2.3.</strong> Errors</a></li><li class="chapter-item expanded "><a href="../02_basics/05_middleware.html"><strong aria-hidden="true">2.4.</strong> Middleware</a></li><li class="chapter-item expanded "><a href="../02_basics/06_jobs.html"><strong aria-hidden="true">2.5.</strong> Jobs</a></li><li class="chapter-item expanded "><a href="../02_basics/07_web_sockets.html"><strong aria-hidden="true">2.6.</strong> Web sockets</a></li></ol></li><li class="chapter-item expanded "><a href="../03_advanced/01_chapter.html"><strong aria-hidden="true">3.</strong> Advanced</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../03_advanced/02_extractors.html" class="active"><strong aria-hidden="true">3.1.</strong> Extractors</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Web Asynchronous Programming in Rust with darpi</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#extractors" id="extractors">Extractors</a></h1>
<p>As we learned from the <a href="../02_basics/03_handlers.html">Handlers</a> chapter, we can get a request body by declaring <code>#[body] payload: Json&lt;Name&gt;</code> in the handler arguments. </p>
<p>Extractors are a way to get a request body in a certain format.</p>
<p>While the framework provides <code>Json</code>, <code>Xml</code> and <code>Yaml</code> extractor implementations, you might need to implement your own. </p>
<p>To do that, we need to implement the <code>FromRequestBody</code> or <code>FromRequestBodyWithContainer</code> trait, depending on whether we need to use the dependency injection container.</p>
<p>Lets start with <code>FromRequestBody</code>. The trait definition is as follows.
As you can see, we have 2 generic types.
If in any case, an error is returned from the trait methods, the request processing will immediately stop and an error response will be returned to the client.
This is the reason the <code>E</code> type has <code>ResponderError</code> bounds.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
pub trait FromRequestBody&lt;T, E&gt;
where
    T: de::DeserializeOwned + 'static,
    E: ResponderError + 'static,
{
    async fn assert_content_type(_content_type: Option&lt;&amp;HeaderValue&gt;) -&gt; Result&lt;(), E&gt; {
        Ok(())
    }
    async fn extract(headers: &amp;HeaderMap, b: Body) -&gt; Result&lt;T, E&gt;;
}
<span class="boring">}
</span></code></pre></pre>
<p>As the implementor, we need to decide whether we want to require the content type header or not.
You can choose to not have it as a requirement from the client, then you can simply not implement it and use the default implementation.
And finally, the <code>extract</code> method is the thing that does most of the work.
You can very well imagine that a basic implementation of the would be as follows.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use darpi::hyper::body;
pub struct MyFormat&lt;T&gt;(pub T);

#[async_trait]
impl&lt;T&gt; FromRequestBody&lt;MyFormat&lt;T&gt;, MyErr&gt; for MyFormat&lt;T&gt;
    where
        T: DeserializeOwned + 'static,
{
    async fn assert_content_type(content_type: Option&lt;&amp;HeaderValue&gt;) -&gt; Result&lt;(), MyErr&gt; {
        if let Some(hv) = content_type {
            if hv != &quot;application/my_format&quot; {
                return Err(MyErr::InvalidContentType);
            }
            return Ok(());
        }
        Err(MyErr::MissingContentType)
    }
    async fn extract(_: &amp;HeaderMap, b: Body) -&gt; Result&lt;MyFormat&lt;T&gt;, MyErr&gt; {
        let full_body = body::to_bytes(b).await?;
        // here is where we need to deserialize the full_body bytes
        // for the example, serde_json is used.
        let ser: T = serde_json::from_slice(&amp;full_body)?;
        Ok(MyFormat(ser))
    }
}

#[derive(Display)]
pub enum MyErr {
    ReadBody(hyper::Error),
    Serde(Error),
    InvalidContentType,
    MissingContentType,
}

impl From&lt;Error&gt; for MyErr {
    fn from(e: Error) -&gt; Self {
        Self::Serde(e)
    }
}

impl From&lt;hyper::Error&gt; for MyErr {
    fn from(e: hyper::Error) -&gt; Self {
        Self::ReadBody(e)
    }
}

impl ResponderError for MyErr {}
<span class="boring">}
</span></code></pre></pre>
<p>If you have dependencies that you need to access, you can instead implement <code>FromRequestBodyWithContainer</code>.
The implementation of the methods is exactly the same as above. The only difference is the <code>C</code> generic type that you need to specify the relevant bounds.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl&lt;F, T, E, C&gt; FromRequestBodyWithContainer&lt;T, E, C&gt; for F
where
    F: FromRequestBody&lt;T, E&gt; + 'static,
    T: de::DeserializeOwned + 'static,
    E: ResponderError + 'static,
    C: std::any::Any + Sync + Send,
{
    async fn assert_content_type(content_type: Option&lt;&amp;HeaderValue&gt;, _: Arc&lt;C&gt;) -&gt; Result&lt;(), E&gt; {
        F::assert_content_type(content_type).await
    }
    async fn extract(headers: &amp;HeaderMap&lt;HeaderValue&gt;, b: Body, _: Arc&lt;C&gt;) -&gt; Result&lt;T, E&gt; {
        F::extract(headers, b).await
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>As an example, we can see the <code>graphql</code> integration implements this trait.
As you can see the line <code>let opts = container.resolve().get();</code> is how you can fetch the specified dependency.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait MultipartOptionsProvider: Interface {
    fn get(&amp;self) -&gt; MultipartOptions;
}

#[derive(Component)]
#[shaku(interface = MultipartOptionsProvider)]
pub struct MultipartOptionsProviderImpl {
    opts: MultipartOptions,
}

impl MultipartOptionsProvider for MultipartOptionsProviderImpl {
    fn get(&amp;self) -&gt; MultipartOptions {
        self.opts.clone()
    }
}

#[async_trait]
impl&lt;C: 'static&gt; FromRequestBodyWithContainer&lt;GraphQLBody&lt;BatchRequest&gt;, GraphQLError, C&gt;
for GraphQLBody&lt;BatchRequest&gt;
    where
        C: HasComponent&lt;dyn MultipartOptionsProvider&gt;,
{
    async fn extract(
        headers: &amp;HeaderMap,
        mut body: darpi::Body,
        container: Arc&lt;C&gt;,
    ) -&gt; Result&lt;GraphQLBody&lt;BatchRequest&gt;, GraphQLError&gt; {
        let content_type = headers
            .get(http::header::CONTENT_TYPE)
            .and_then(|value| value.to_str().ok())
            .map(|value| value.to_string());

        let (tx, rx): (
            Sender&lt;std::result::Result&lt;Bytes, _&gt;&gt;,
            Receiver&lt;std::result::Result&lt;Bytes, _&gt;&gt;,
        ) = bounded(16);

        darpi::job::FutureJob::from(async move {
            while let Some(item) = body.next().await {
                if tx.send(item).await.is_err() {
                    return;
                }
            }
        })
            .spawn()
            .map_err(|e| GraphQLError::Send(e.to_string()))?;

        let opts = container.resolve().get();
        Ok(GraphQLBody(BatchRequest(
            async_graphql::http::receive_batch_body(
                content_type,
                rx.map_err(|e| std::io::Error::new(std::io::ErrorKind::InvalidInput, e))
                    .into_async_read(),
                opts,
            )
                .await
                .map_err(|e| GraphQLError::ParseRequest(e))?,
        )))
    }
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../03_advanced/01_chapter.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../03_advanced/01_chapter.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
